<h2>Payvision Calculator</h2>

<div id="calculator" class="calculator">
  <button id="clear" class="clear">C</button>

  <div id="viewer" class="viewer">0</div>

  <button class="num" data-num="9">9</button>
  <button class="num" data-num="8">8</button>
  <button class="num" data-num="7">7</button>
  <button data-ops="plus" class="ops">+</button>

  <button class="num" data-num="4">4</button>
  <button class="num" data-num="5">5</button>
  <button class="num" data-num="6">6</button>
  <button data-ops="minus" class="ops">-</button>

  <button class="num" data-num="0">0</button>
  <button class="num" data-num="1">1</button>
  <button class="num" data-num="2">2</button>

  <button class="num" data-num="3">3</button>
  <button id="dot">.</button>
  <button id="equals" class="equals" data-result="">=</button>
  
  <button data-ops="multiply" class="ops">*</button>
  <button data-ops="divide" class="ops">%</button>
</div>

<style>
  body {
    background-color: #be3c50;
    font: 300 18px/1.6 "Source Sans Pro", sans-serif;
    margin: 0;
    padding: 5em 0 2em;
    text-align: center;
    color: rgb(200, 255, 225);
  }

  h2 {
    font-weight: 300;
    margin: 0;
  }

  .calculator {
    font-size: 28px;
    margin: 0 auto;
    width: 10em;
  }

  .calculator::before, .calculator::after {
    content: " ";
    display: table;
  }

  .calculator::after {
    clear: both;
  }

  .broken {
    animation: broken 2s;
    transform: translate3d(0, -2000px, 0);
    opacity: 0;
  }

  .viewer {
    float: left;
    line-height: 3em;
    text-align: right;
    overflow-x: auto;
    overflow-y: hidden;
    width: 7.5em;
    height: 3em;
  }

  button {
    border: 0;
    background: rgba(42, 50, 113, 0.28);
    color: rgb(200, 255, 225);
    cursor: pointer;
    float: left;
    font: inherit;
    margin: 0.25em;
    width: 2em;
    height: 2em;
    transition: all 0.5s;

    box-shadow: -3px 3px rgba(42, 50, 113, 0.28), -2px 2px rgba(42, 50, 113, 0.28), -1px 1px rgba(42, 50, 113, 0.28);
  }

  button:focus {
    transition: all 0.1s;
    filter: hue-rotate(-90deg);
  }
  
</style>

<script>
  (function() {
    // Shortcuts to get elements
    var el = document.querySelector.bind(document);
    var els = document.querySelectorAll.bind(document);

    // Variables
    var viewer = el("#viewer"), // Calculator screen where result is displayed
      equals = el("#equals"), // Equal button
      nums = els(".num"), // List of numbers
      ops = els(".ops"), // List of operators
      clear = el("#clear"), // C button
      dot = el("#dot"), // Dot button
      calculator = el("#calculator"), // Full calculator
      writerNum = "", // Variable to store and simplify number adding
      currentNumDecimals = 0, // Number of decimals of current writing number
      oldNum, // First number
      resultNum, // Result
      operator, // Batman,
      maxDecimals = 10, // maximum allowed number of decimals
      debounceButtons = false, // debouncer for numbers
      dotPressed = false, // Control variable allowing to manage dot pressing 
      powerOfTen = Math.pow(10, maxDecimals); // Power of ten to operate with integers


    // Defensive way to get a valid number formatter
    var numberFormatter = function (input) { return input; }
    if (Intl) {
      numberFormatter = new Intl.NumberFormat(["en"], {maximumFractionDigits: maxDecimals}).format;
    }

    // When: Number is clicked. Get the current number selected
    var setNum = function() {
      // If we reached max decimal numbers, dont add
      if (currentNumDecimals > maxDecimals) return;
      if (resultNum) {
        // If a result was displayed, reset number
        writerNum = this.getAttribute("data-num");
        resultNum = 0;
        currentNumDecimals = 0;
      } else {
        writerNum += this.getAttribute("data-num");
      }
      if (dotPressed) currentNumDecimals++;

      // We get integer and float, to make "0"s appear as decimal when are at right
      var splittedNumber = writerNum.split(".");
      var integerPart = splittedNumber[0];
      var floatPart = splittedNumber[1];

      viewer.innerHTML = numberFormatter(integerPart) + (floatPart ? '.' + floatPart : ''); // Display current number
    };

    // When: Dot is clicked. Set dotpressed true
    var addDot = function() {
      if (!dotPressed) {
        if (resultNum) {
          writerNum = "0";
          resultNum = 0;
        }
        if (!writerNum) {
          writerNum = "0";
        }
        writerNum += ".";

        viewer.innerHTML = numberFormatter(writerNum); // Display current number
        dotPressed = true;
      }
    }

    // When: Operator is clicked. Pass number to oldNum and save operator
    var moveNum = function() {
      if (oldNum !== undefined) {
        displayNum();
      }
      oldNum = parseFloat(writerNum);
      currentNumDecimals = 0;

      writerNum = "";
      dotPressed = false;
      
      operator = this.getAttribute("data-ops");

      equals.setAttribute("data-result", ""); // Reset result in attr
    };

    // When: Equals is clicked. Calculate result
    var displayNum = function() {
      // we shouldn't allow to parse a empty writerNum or trying to operate without oldNum
      if (!writerNum || !oldNum) return;
      var theNum = parseFloat(writerNum);

      // Perform operation. We will use the powerOfTen variable to modify
      // theNum and oldNum, to perform integer operations
      switch (operator) {
        case "minus":
          resultNum = (oldNum * powerOfTen) - (theNum * powerOfTen);
          resultNum = resultNum / powerOfTen;
          break;

        case "plus":
          resultNum = (oldNum * powerOfTen) + (theNum * powerOfTen);
          resultNum = resultNum / powerOfTen;
          break;

        case "multiply":

          resultNum = oldNum * theNum * powerOfTen;
          resultNum = Math.round(resultNum) / powerOfTen;
          break;

        case "divide":
          resultNum = (oldNum / theNum) * powerOfTen;
          resultNum = Math.round(resultNum) / powerOfTen;
          break;

        // If equal is pressed without an operator, keep number and continue
        default:
          resultNum = theNum;
      }


      // If NaN or Infinity returned
      if (!isFinite(resultNum)) {
        if (isNaN(resultNum)) {
          // If result is not a number; set off by, eg, double-clicking operators
          displayResult("You broke it!");
        } else {
          // If result is infinity, set off by dividing by zero
          displayResult("Look at what you've done");
          calculator.classList.add("broken"); // Break calculator
        }
      } else {
        // Display result, finally!
        displayPrettyResult(resultNum);
      }

      // Now reset oldNum & keep result
      oldNum = undefined;
      writerNum = resultNum.toString();
      dotPressed = false;
    };

    // When: Clear button is pressed. Clear everything
    var clearAll = function() {
      oldNum = undefined;
      writerNum = "";
      dotPressed = false;

      displayResult(0);
    };

    // Bind keyboard events to calculator
    var onKeyPress = function(e) {
      if (debounceButtons) return;
      var element;
      switch (e.key) {
        // Numbers
        case "1":
        case "2":
        case "3":
        case "4":
        case "5":
        case "6":
        case "7":
        case "8":
        case "9":
        case "0":
          element = document.querySelector("[data-num='" + e.key + "']");
          break;
        case ".":
          element = document.querySelector("#dot");
          break;

        // Operations
        case "+":
          element = document.querySelector("[data-ops='plus']");
          break;
        case "-":
          element = document.querySelector("[data-ops='minus']");
          break;
        case "/":
          element = document.querySelector("[data-ops='divide']");
          break;
        case "*":
          element = document.querySelector("[data-ops='multiply']");
          break;

        // Equals
        case "=":
        case "Enter":
          element = document.querySelector("#equals");
          break;

        // C
        case "c":
        case "C":
          element = document.querySelector("#clear");
          break;
      }
      debounceButtons = true;

      element.focus();
      element.click();
      setTimeout(function() {
        debounceButtons = false;
        element.blur();
      }, 500);
    }

    // Private helper to set result where is needed
    function displayResult(result) {
      viewer.innerHTML = result;
      equals.setAttribute("data-result", result);
    }

    // Private helper to show pretty result
    function displayPrettyResult(result) {
      viewer.innerHTML = numberFormatter(result);
      equals.setAttribute("data-result", result);
    }

    /* The click events */

    // Add click event to numbers
    for (var i = 0, l = nums.length; i < l; i++) {
      nums[i].onclick = setNum;
    }

    // Add click event to operators
    for (var i = 0, l = ops.length; i < l; i++) {
      ops[i].onclick = moveNum;
    }

    // Add click event to equal sign
    equals.onclick = displayNum;

    // Add click event to clear button
    clear.onclick = clearAll;

    // Add click event to dot button
    dot.onclick = addDot;

    // Add keyboard interaction
    document.body.onkeypress = onKeyPress;
  })();
</script>
